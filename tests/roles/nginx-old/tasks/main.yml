---

- name: Install required packages
  apt:
    name: "{{ item }}"
    force: yes
    state: latest
    update_cache: yes
  with_items: "{{nginx_packages}}"
  tags:
    skip_ansible_lint

- name: NGINX | Create build folder
  file:
    path: /nginxbuild
    state: directory

- name: Download headers-more module
  get_url:
    url: https://github.com/openresty/headers-more-nginx-module/archive/v{{ headers_more_version }}.tar.gz
    dest: /nginxbuild
    validate_certs: no

- name: Untar headers-more
  unarchive:
    copy: no
    src: /nginxbuild/headers-more-nginx-module-{{ headers_more_version }}.tar.gz
    dest: /nginxbuild

- name: Download nginx
  get_url:
    url: http://nginx.org/download/nginx-{{ nginx_old_version }}.tar.gz
    dest: /nginxbuild

- name: Untar nginx
  unarchive:
    copy: no
    src: /nginxbuild/nginx-{{ nginx_old_version }}.tar.gz
    dest: /nginxbuild

# - name: Install nginx
#   command: "chdir=/nginxbuild/nginx-{{ nginx_old_version }} {{item}}"
#   with_items:
#     - ./configure
#         --prefix=/usr
#         --add-module=/nginxbuild/headers-more-nginx-module-{{ headers_more_version }}
#         --conf-path={{ nginx_conf }}
#         --error-log-path={{ nginx_err }}
#         --http-log-path={{ nginx_acc }}
#         --pid-path=/var/run/nginx.pid
#         --lock-path=/var/lock/nginx.lock
#     - make
#     - make install
#   tags:
#     skip_ansible_lint

- name: NGINX | Configure install
  command: ./configure --prefix=/usr --add-module=/nginxbuild/headers-more-nginx-module-{{ headers_more_version }} --conf-path={{ nginx_conf }} --error-log-path={{ nginx_err }} --http-log-path={{ nginx_acc }} --pid-path=/var/run/nginx.pid --lock-path=/var/lock/nginx.lock
  args:
    chdir: /nginxbuild/nginx-{{ nginx_old_version }}
  tags:
    skip_ansible_lint

- name: NGINX | Make
  make:
    chdir: /nginxbuild/nginx-{{ nginx_old_version }}
  tags:
    skip_ansible_lint

- name: NGINX | Make install
  make:
    chdir: /nginxbuild/nginx-{{ nginx_old_version }}
    target: install
  tags:
    skip_ansible_lint

- name: Copy nginx config
  template:
    src: nginx.conf
    dest: /etc/nginx
  notify: restart nginx

- name: Create extra configuration directory
  file:
    path: /etc/nginx/{{ item }}
    state: directory
  with_items:
    - sites-available
    - sites-enabled

- name: Copy Daemon script
  copy:
    src: daemon
    dest: /etc/init.d/nginx
    mode: 0755
  notify: restart nginx

- name: Update rc
  shell: update-rc.d -f nginx defaults
  changed_when: false
  tags:
    skip_ansible_lint

- name: Copy logrotate config
  copy:
    src: logrotate
    dest: /etc/logrotate.d/nginx
